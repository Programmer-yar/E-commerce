{% extends "base.html" %}

{% block title %} Cart | {% endblock %}


{% block content %}
  <div id="cartPage" class="mt-5">
    

    <!-- Shopping Cart -->
    <div class="shopping-cart section">
      <div class="container" v-if="products.length > 0">
        <div class="row">
          <div class="col-12">
            <!-- Shopping Summery -->
            <table class="table shopping-summery">
              <thead>
                <tr class="main-hading">
                  <th>PRODUCT</th>
                  <th>NAME</th>
                  <th class="text-center">UNIT PRICE</th>
                  <th class="text-center">QUANTITY</th>
                  <th class="text-center">TOTAL</th> 
                  <th class="text-center"><i class="fa fa-trash"></i></th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="product in products">
                  <td class="image" data-title="No"><img src="https://via.placeholder.com/100x100" alt="#"></td>
                  <td class="product-des" data-title="Description">
                    <p class="product-name"><a href="#">[[ product.title ]]</a></p>
                    <p class="product-des"></p>
                  </td>
                  <td class="price" data-title="Price"><span>[[ product.price ]]</span></td>
                  <td class="qty" data-title="Qty"><!-- Input Order -->
                    <div class="input-group">
                      <div class="button minus">
                        <button type="button" class="btn btn-primary btn-number" :disabled="product.quantity == 1"
                        @click="decrementQuantity(product.id, product.quantity, product.price)"><i class="fa fa-minus"></i>
                        </button>
                      </div>
                      <input type="integer" class="input-number"
                      min="1" max="100" :value="product.quantity">
                      <div class="button plus">
                        <button type="button" class="btn btn-primary btn-number" @click="incrementQuantity(product.id, product.quantity, product.price)">
                          <i class="fa fa-plus"></i>
                        </button>
                      </div>
                    </div>
                    <!--/ End Input Order -->
                  </td>
                  <td class="total-amount" data-title="Total"><span>[[ product.total_price ]]</span></td>
                  <td class="action" data-title="Remove"><a href="" @click="removeProduct(product.id)"><i class="fa fa-times"></i></a></td>
                </tr>
              </tbody>
            </table>
            <!--/ End Shopping Summery -->
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <!-- Total Amount -->
            <div class="total-amount">
              <div class="row">
                <div class="col-lg-8 col-md-5 col-12">
                  <div class="left">
                    <div class="coupon">
                      
                      <input name="Coupon" placeholder="Enter Your Coupon" v-model="coupon_code">
                      <input type="hidden" v-model="coupon_value">
                      <button class="btn">Apply</button>
                      
                    </div>
                    <!-- <div class="checkbox">
                      <label class="checkbox-inline" for="2"><input name="news" id="2" type="checkbox"> Shipping (+10$)</label>
                    </div> -->
                  </div>
                </div>
                <div class="col-lg-4 col-md-7 col-12">
                  <div class="right">
                    <ul>
                      <li>Cart Subtotal<span>${{ cart.get_total_cost }}</span></li>
                      <li>Shipping<span>Free</span></li>
                      <!-- <li>You Save<span>$20.00</span></li> -->
                      <li class="last">You Pay<span>$[[ totalCostWithCoupon ]]</span></li>
                    </ul>
                    <div class="button5">
                      <a href="#" class="btn">Checkout</a>
                      <a href="#" class="btn">Continue shopping</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!--/ End Total Amount -->
          </div>
        </div>
      </div>
      <div class="container" v-else>
        <h3>No Products in cart</h3>
      </div>
    </div>
    <!--/ End Shopping Cart -->
    
  </div>

{% endblock%}


{% block scripts %}

<!-- Importing "Stripe.js" for for stripe integration -->
<script type="application/javascript" src="https://js.stripe.com/v3/">
</script>

<script>
  var productapp = new Vue({

      el: '#cartPage',
      delimiters: ['[[', ']]'],
      store:store,

      data() {
        return {
          errors: [],
          first_name: '',
          last_name: '',
          email: '',
          address: '',
          zipcode: '',
          place: '',
          products: [{{ productstring|safe }}],
          coupon_code: '',
          coupon_value: ''
        }
      },

      computed: {
        numItems:function() {
          return store.state.numItems
        },

        totalCost: function() {
          return store.state.totalCost
        },

        totalCostWithCoupon: function() {
          if (this.coupon_value > 0) {
            let percent = parseFloat(this.coupon_value/100);
            return store.state.totalCost * percent;
          } else {
            return store.state.totalCost;
          }
        },

      },


      methods: {
        applyCoupon(){
          if (this.coupon_code !== ''){
            fetch('/api/can_use/?coupon_code=' + this.coupon_code,{
              method: 'GET'
            })
            .then((response) => {
              return response.json();
            })
            .then((data) => {
              if (data.amount){
                this.coupon_value = parseInt(data.amount)
              } else {
                this.coupon_value = 0
              }
            });

          }
        },

        buy() {
          var data = {
            'first_name': this.first_name,
            'last_name': this.last_name,
            'email': this.email,
            'address': this.address,
            'zipcode': this.zipcode,
            'place': this.place,
            'coupon_code': this.coupon_code
          };

          //for displaying errors
          this.errors = [];

          var stripe = Stripe('{{ pub_key }}');
          
          fetch('/api/create_checkout_session', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            credentials: 'same-origin',
            
            //converts JS object/dict into string
            body: JSON.stringify(data)
          })
          .then(function(response) {
            return response.json();
          })
          .then(function(session) {
            return stripe.redirectToCheckout({sessionId: session.id})
          })
          .then(function(result) {
            if (result.error) {
              alert(result.error.message)
            }
          })
          .catch(function(error){
            console.log('Error: ', error);
          });
        },


        incrementQuantity(product_id, quantity, price) {
          var data = {
            'product_id': product_id,
            'update': true,
            'quantity': parseInt(quantity) + 1
          };

          //Use of 'Vuex'
          store.commit('increment', 1);
          store.commit('changeTotalCost', parseFloat(price));

          //can also use axios
          fetch('/api/add_to_cart', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
          })
          .then((response) => {
            console.log(response)

            for (var i=0; i<this.products.length; i++) {
              var product = this.products[i];

              if (product.id === product_id) {
                this.products[i].quantity = parseInt(this.products[i].quantity) + 1;
                this.products[i].total_price = parseInt(this.products[i].quantity) * parseFloat(this.products[i].price)
              }
            }
          })
          .catch(function (error) {
            console.log('Error 2');
            console.log(error);
          })

        },

        decrementQuantity(product_id, quantity, price) {
          var data = {
            'product_id': product_id,
            'update': true,
            'quantity': parseInt(quantity) - 1
          };

          //Use of 'Vuex'
          store.commit('increment', -1);
          store.commit('changeTotalCost', -parseFloat(price));

          //Checks to see if quantity is set to 0
          if (data['quantity'] === 0) {
            this.removeProduct(product_id);
          } else {

            //can also use axios
          fetch('/api/add_to_cart', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
          })
          .then((response) => {
            console.log(response)

            for (var i=0; i<this.products.length; i++) {
              var product = this.products[i];

              if (product.id === product_id) {
                this.products[i].quantity = parseInt(this.products[i].quantity) - 1;
                this.products[i].total_price = parseInt(this.products[i].quantity) * parseFloat(this.products[i].price)
              }
            }
          })
          .catch(function (error) {
            console.log('Error 2');
            console.log(error);
          })

          }

        },

        removeProduct(product_id) {
          var data = {
            'product_id': product_id, 
          };

          fetch('/api/remove_from_cart', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
          })
          .then((response) => {
            console.log(response)
            console.log(product_id)
            this.products = this.products.filter(product => product.id !== product_id)
            //console.log(this.products)
          })
          
          .catch(function (error) {
            console.log('Error 2');
            console.log(error);
          })
        }
      },
});
</script>
{% endblock %}